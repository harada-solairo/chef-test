<source>
  type forward
  bind 0.0.0.0
  port 24224
</source>

<% node[:deploy].each do |application, deploy| %>
<% if deploy[:domains].nil? %><% next %><% end %>
<match rails>
  type        record_reformer
  tag         td.<%= deploy[:domains].first.gsub(/\./,'-') %>.log.rails
</match>

<source>
  type config_expander
  <config>
    type tail
    path        /var/log/httpd/<%= application %>-access.log
    format      ltsv
    time_key    time
    time_format %d/%b/%Y:%H:%M:%S %z
    pos_file    /var/log/td-agent/<%= application %>-access.pos
    tag         <%= deploy[:domains].first.gsub(/\./,'-') %>.apache.access
  </config>
</source>
<match <%= deploy[:domains].first.gsub(/\./,'-') %>.apache.access>
  type grep
  exclude1 agent HealthChecker
  add_tag_prefix td
</match>

<source>
  type config_expander
  <config>
    type tail
    format      /^\[[^ ]* (?<time>[^\]]*)\] \[(?<level>[^\]]*)\] \[pid (?<pid>[^\]]*)\] \[client (?<client>[^\]]*)\] (?<message>.*)$/
    path        /var/log/httpd/<%= application %>-error.log
    pos_file    /var/log/td-agent/<%= application %>.error_log.pos
    tag         td.<%= deploy[:domains].first.gsub(/\./,'-') %>.apache.error
  </config>
</source>
<% end %>

<% instanceid = `wget -q -O - http://169.254.169.254/latest/meta-data/instance-id` %>
<source>
  type config_expander
  <config>
    type         tail
    format       syslog
    path         /var/log/messages
    pos_file     /var/log/td-agent/syslog.messages.pos
    tag          td.instances.<%= instanceid %>.syslog
  </config>
</source>

## Output
<match td.**>
  type forward
  buffer_type         file
  buffer_path         /var/tmp/${tag}
  flush_interval      5s
  buffer_chunk_limit  4k
  buffer_queue_limit  128
  retry_wait          10s
  retry_limit         5
  flush_at_shutdown   true
  <server>
    host internal-development-fluentd-aggregator-1997960583.ap-northeast-1.elb.amazonaws.com 
    port 24224 
    weight 50
  </server>
</match>
